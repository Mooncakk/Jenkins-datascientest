pipeline{
    agent any

    environment {
                GITHUB_TOKEN  = credentials('github_tok')
                REPO_OWNER = 'mooncakk'
                REPO_NAME = 'jenkins-datascientest'
    }
    parameters {
        string(
            name: 'BRANCH_NAME',
            defaultValue: 'staging',
            description: 'Source branch for the pull request'
        )
        string(
            name: 'BASE_BRANCH',
            defaultValue: 'main',
            description: 'Target branch for the pull request'
        )
        choice( //Modifier
            name: 'MERGE_METHOD',
            choices: ['SQUASH', 'MERGE', 'REBASE'],
            description: 'Auto-merge method'
        )
        string(
            name: 'PR_NUMBER',
            defaultValue: '17',
            description: 'pull request number'
        )
        string(
            name: 'env.PR_NODE_ID',
            defaultValue: 'PR_kwDOPOTiSM6iSH8d',
            description: 'pull request ID'
        )
    }

    stages {

        stage('Debug Auto-Merge (Fixed Fields)') {
            steps {
                script {
                    echo "ğŸ› DEBUG: Checking PR with correct GraphQL fields..."

                    // âœ… CORRECT field names for GitHub GraphQL API
                    // ğŸ”Œ REQUIRES: HTTP Request Plugin
                    def prQueryResponse = httpRequest(
                        httpMode: 'POST',
                        url: 'https://api.github.com/graphql',
                        customHeaders: [
                            [name: 'Authorization', value: "token ${GITHUB_TOKEN}"],
                            [name: 'Content-Type', value: 'application/json']
                        ],
                        requestBody: """{
                            "query": "query { node(id: \\"PR_kwDOPOTiSM6iSH8d\\") { id ... on PullRequest { number title state mergeable mergeStateStatus autoMergeRequest { enabledAt enabledBy { login } mergeMethod } } } }"
                        }"""
                    )

                    // ğŸ”Œ REQUIRES: Pipeline Utility Steps Plugin
                    def prQueryResult = readJSON text: prQueryResponse.content
                    echo "ğŸ“„ GraphQL PR Query Result:"
                    echo "${prQueryResponse.content}"

                    // Parse the results
                    if (prQueryResult.errors) {
                        echo "âŒ GraphQL Errors:"
                        prQueryResult.errors.each { error ->
                            echo "  - ${error.message}"
                        }
                    } else if (prQueryResult.data?.node) {
                        def pr = prQueryResult.data.node
                        echo "âœ… PR Found:"
                        echo "  ğŸ“‹ Number: ${pr.number}"
                        echo "  ğŸ“ Title: ${pr.title}"
                        echo "  ğŸ“Š State: ${pr.state}"
                        echo "  ğŸ”€ Mergeable: ${pr.mergeable}"
                        echo "  ğŸš¦ Merge State: ${pr.mergeStateStatus}"

                        if (pr.autoMergeRequest) {
                            echo "  âœ… Auto-merge: Enabled"
                            echo "  â° Enabled at: ${pr.autoMergeRequest}"
                            echo "  ğŸ‘¤ Enabled by: ${pr.autoMergeRequest.enabledBy.login}"
                            echo "  ğŸ”§ Method: ${pr.autoMergeRequest.mergeMethod}"
                        } else {
                            echo "  âŒ Auto-merge: Not enabled"
                        }
                    } else {
                        echo "âŒ No PR data found"
                    }
                }
            }
        }
    }
}